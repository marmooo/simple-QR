function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function tick(e){if(video.readyState===video.HAVE_ENOUGH_DATA){{loadingMessage.hidden=!0;const t=video.videoWidth,n=video.videoHeight;if(canvasElement.width=t,canvasElement.height=n,canvas.drawImage(video,0,0,t,n),e-prevTime>500){prevTime=e;const s=canvas.getImageData(0,0,t,n);worker.postMessage({data:s.data,width:t,height:n})}}}else loadingMessage.textContent="⌛ Loading video...";requestAnimationFrame(tick)}async function copyToClipboard(e){await navigator.clipboard.writeText(e),alert("クリップボードにコピーしました。")}function initWorker(){const e=new Worker("/simple-QR/koder.js");return e.onmessage=e=>{const t=e.data.data;if(!t)return;outputMessage.hidden=!1,outputData.parentElement.hidden=!1,outputData.textContent=t;try{new URL(t),outputData.href=t}catch{}playAudio("correct")},e}function initScan(){navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(e=>{video.srcObject=e,video.setAttribute("playsinline","true"),video.play(),requestAnimationFrame(tick)}).catch(e=>{alert(e.message)})}loadConfig();let prevTime=0;const audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","/simple-QR/mp3/correct3.mp3");const video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d",{willReadFrequently:!0}),loadingMessage=document.getElementById("loadingMessage"),outputMessage=document.getElementById("outputMessage"),outputData=document.getElementById("outputData"),worker=initWorker();initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("copyToClipboard").onclick=copyToClipboard,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})