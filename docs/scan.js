function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}async function playAudio(b,c){const d=await loadAudio(b,audioBufferCache[b]),a=audioContext.createBufferSource();if(a.buffer=d,c){const b=audioContext.createGain();b.gain.value=c,b.connect(audioContext.destination),a.connect(b),a.start()}else a.connect(audioContext.destination),a.start()}async function loadAudio(a,c){if(audioBufferCache[a])return audioBufferCache[a];const d=await fetch(c),e=await d.arrayBuffer(),b=await audioContext.decodeAudioData(e);return audioBufferCache[a]=b,b}function unlockAudio(){audioContext.resume()}function tick(a){if(video.readyState===video.HAVE_ENOUGH_DATA){{loadingMessage.hidden=!0;const b=video.videoWidth,c=video.videoHeight;if(canvasElement.width=b,canvasElement.height=c,canvas.drawImage(video,0,0,b,c),a-prevTime>500){prevTime=a;const d=canvas.getImageData(0,0,b,c);worker.postMessage({data:d.data,width:b,height:c})}}}else loadingMessage.textContent="⌛ Loading video...";requestAnimationFrame(tick)}async function copyToClipboard(a){await navigator.clipboard.writeText(a),alert("クリップボードにコピーしました。")}function initWorker(){const a=new Worker("/simple-QR/koder.js");return a.onmessage=b=>{const a=b.data.data;if(!a)return;outputMessage.hidden=!1,outputData.parentElement.hidden=!1,outputData.textContent=a;try{new URL(a),outputData.href=a}catch{}playAudio("correct")},a}function initScan(){navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(a=>{video.srcObject=a,video.setAttribute("playsinline","true"),video.play(),requestAnimationFrame(tick)}).catch(a=>{alert(a.message)})}loadConfig();let prevTime=0;const audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","/simple-QR/mp3/correct3.mp3");const video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d"),loadingMessage=document.getElementById("loadingMessage"),outputMessage=document.getElementById("outputMessage"),outputData=document.getElementById("outputData"),worker=initWorker();initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("copyToClipboard").onclick=copyToClipboard,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})