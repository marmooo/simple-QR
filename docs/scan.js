function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("correct","/simple-QR/mp3/correct3.mp3")),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}function tick(e){if(video.readyState===video.HAVE_ENOUGH_DATA){{loadingMessage.hidden=!0;const t=video.videoWidth,n=video.videoHeight;if(canvasElement.width=t,canvasElement.height=n,canvas.drawImage(video,0,0,t,n),e-prevTime>500){prevTime=e;const s=canvas.getImageData(0,0,t,n);worker.postMessage({data:s.data,width:t,height:n})}}}else loadingMessage.textContent="⌛ Loading video...";requestAnimationFrame(tick)}async function copyToClipboard(e){await navigator.clipboard.writeText(e),alert("クリップボードにコピーしました。")}function initWorker(){const e=new Worker("/simple-QR/koder.js");return e.onmessage=e=>{const t=e.data.data;if(!t)return;outputMessage.hidden=!1,outputData.parentElement.hidden=!1,outputData.textContent=t;try{new URL(t),outputData.href=t}catch{}playAudio("correct")},e}function initScan(){navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(e=>{video.srcObject=e,video.setAttribute("playsinline","true"),video.play(),requestAnimationFrame(tick)}).catch(e=>{alert(e.message)})}loadConfig();let prevTime=0,audioContext;const audioBufferCache={},video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d",{willReadFrequently:!0}),loadingMessage=document.getElementById("loadingMessage"),outputMessage=document.getElementById("outputMessage"),outputData=document.getElementById("outputData"),worker=initWorker();initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("copyToClipboard").onclick=copyToClipboard,document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0})